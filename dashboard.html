<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHPaibot Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .mood-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .mood-optimistic { background: #d4edda; color: #155724; }
        .mood-positive { background: #cce5ff; color: #004085; }
        .mood-neutral { background: #e2e3e5; color: #383d41; }
        .mood-concerned { background: #fff3cd; color: #856404; }
        .mood-troubled { background: #f8d7da; color: #721c24; }
        .activity-item {
            padding: 10px;
            border-left: 3px solid #007bff;
            margin-bottom: 10px;
            background: #f8f9fa;
        }
        .activity-news { border-left-color: #28a745; }
        .activity-conversation { border-left-color: #007bff; }
        .timestamp {
            font-size: 0.8em;
            color: #6c757d;
        }
        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .topics {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .topic-tag {
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        .news-item {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }
        .news-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .news-title a {
            color: #007bff;
            text-decoration: none;
        }
        .news-title a:hover {
            text-decoration: underline;
        }
        .news-reaction {
            font-style: italic;
            color: #6c757d;
            margin-top: 5px;
        }
        .mood-score {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .mood-positive { background: #d4edda; color: #155724; }
        .mood-negative { background: #f8d7da; color: #721c24; }
        .mood-neutral { background: #e2e3e5; color: #383d41; }
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            float: right;
        }
        .delete-btn:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PHPaibot Dashboard</h1>
            <p>Monitor AI mood, recent activity, and system status</p>
            <button class="refresh-btn" onclick="loadDashboard()">Refresh</button>
            <button class="refresh-btn" style="background:#fd7e14;margin-left:8px;" onclick="resetMood()">Reset Mood</button>
            <button class="refresh-btn" style="background:#dc3545;margin-left:8px;" onclick="clearNewsConfirm()">Clear News</button>
            <button id="devMockBtn" class="refresh-btn" style="background:#6f42c1;margin-left:8px;" onclick="toggleDevMockUI()">Dev Mock: <span id="devMockStatus">...</span></button>
        </div>

        <div class="cards">
            <div class="card">
                <h3>AI Mood & State</h3>
                <div id="mood-info">Loading...</div>
                <div id="topics-info"></div>
            </div>

            <div class="card">
                <h3>System Stats</h3>
                <div id="stats-info">Loading...</div>
            </div>
        </div>

        <div class="card">
            <h3>Recent News Stories</h3>
            <button class="refresh-btn" onclick="bulkDeleteWolfram()" style="float: right; background: #dc3545;">Clean Wolfram</button>
            <div id="news-stories">Loading...</div>
        </div>

        <div class="card">
            <h3>Recent Activity</h3>
            <div id="activity-list">Loading...</div>
        </div>
    </div>

    <script>
        // Determine API base. If opened via file:// or hostname is empty, default to localhost:4002
        const detectedBase = (window.location.protocol + '//' + window.location.hostname + (window.location.port ? ':' + window.location.port : ''));
        let API_BASE = detectedBase;
        // Allow overriding via query param ?api_base=
        const params = new URLSearchParams(window.location.search);
        const override = params.get('api_base');
        if (window.location.protocol === 'file:' || !window.location.hostname) {
            API_BASE = override || 'http://localhost:4002';
        } else if (override) {
            API_BASE = override;
        }

        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/api/dashboard`);
                const data = await response.json();
                
                // Update mood info
                const moodClass = `mood-${data.mood.description}`;
                document.getElementById('mood-info').innerHTML = `
                    <p>Score: <strong>${data.mood.score}</strong></p>
                    <p>State: <span class="mood-indicator ${moodClass}">${data.mood.description}</span></p>
                `;
                
                // Update topics
                const topicsHtml = data.mood.topics.map(topic => 
                    `<span class="topic-tag">${topic}</span>`
                ).join('');
                document.getElementById('topics-info').innerHTML = `
                    <div class="topics">${topicsHtml}</div>
                `;
                
                // Update stats
                document.getElementById('stats-info').innerHTML = `
                    <p>Conversations: <strong>${data.stats.totalConversations}</strong></p>
                    <p>News Items: <strong>${data.stats.totalNews}</strong></p>
                    <p>Last Update: <span class="timestamp">${new Date(data.stats.lastUpdate).toLocaleString()}</span></p>
                `;
                
                // Update activity list
                const activityHtml = data.recentActivity.map(item => `
                    <div class="activity-item activity-${item.type}">
                        <strong>${item.type === 'news' ? 'News' : 'Chat'}</strong>: ${item.content}
                        ${item.mood ? `<span class="mood-indicator mood-${item.mood > 0 ? 'positive' : item.mood < 0 ? 'concerned' : 'neutral'}">Mood: ${item.mood}</span>` : ''}
                        <div class="timestamp">${new Date(item.timestamp).toLocaleString()}</div>
                    </div>
                `).join('');
                
                document.getElementById('activity-list').innerHTML = activityHtml || '<p>No recent activity</p>';

                // Update news stories
                const newsHtml = data.newsStories.map(story => `
                    <div class="news-item" id="news-${story.id}">
                        <div class="news-title">
                            ${story.url ? `<a href="${story.url}" target="_blank">${story.title}</a>` : story.title}
                            ${story.mood ? `<span class="mood-score mood-${story.mood > 0 ? 'positive' : story.mood < 0 ? 'negative' : 'neutral'}">${story.mood > 0 ? '+' : ''}${story.mood}</span>` : ''}
                            <button class="delete-btn" onclick="deleteNews(${story.id})">Ã—</button>
                        </div>
                        ${story.reaction ? `<div class="news-reaction">"${story.reaction}"</div>` : ''}
                        ${story.topics ? `<div class="topics">${story.topics.map(topic => `<span class="topic-tag">${topic}</span>`).join('')}</div>` : ''}
                        <div class="timestamp">${new Date(story.timestamp).toLocaleString()}</div>
                    </div>
                `).join('');
                
                document.getElementById('news-stories').innerHTML = newsHtml || '<p>No recent news stories</p>';

                // Refresh admin/dev-mock status
                if (typeof getDevMockStatus === 'function') getDevMockStatus();

            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('mood-info').innerHTML = '<p style="color: red;">Error loading data</p>';
            }
        }

        // Load dashboard on page load
        loadDashboard();
        
        // Auto-refresh every 30 seconds
        setInterval(loadDashboard, 30000);

        // Delete news function
        async function deleteNews(newsId) {
            if (!confirm('Delete this news entry?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/news/${newsId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    document.getElementById(`news-${newsId}`).remove();
                    console.log(`Deleted news entry ${newsId}`);
                } else {
                    alert('Failed to delete news entry');
                }
            } catch (error) {
                console.error('Error deleting news:', error);
                alert('Error deleting news entry');
            }
        }

        // Bulk delete Wolfram Alpha entries
        async function bulkDeleteWolfram() {
            if (!confirm('Delete all Wolfram Alpha entries? This cannot be undone.')) return;
            try {
                const response = await fetch(`${API_BASE}/api/news/bulk`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filter: 'Wolfram' })
                });
                const result = await response.json();
                if (response.ok) {
                    alert(`Deleted ${result.deleted} Wolfram Alpha entries`);
                    loadDashboard(); // Refresh
                } else {
                    alert('Failed to bulk delete entries');
                }
            } catch (error) {
                console.error('Error bulk deleting:', error);
                alert('Error bulk deleting entries');
            }
        }

        // Reset mood via admin endpoint
        async function resetMood() {
            if (!confirm('Reset AI mood to neutral?')) return;
            try {
                const response = await fetch(`${API_BASE}/api/admin/reset-mood`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' });
                const result = await response.json();
                if (response.ok) {
                    alert('Mood reset successfully');
                    loadDashboard();
                } else {
                    alert('Failed to reset mood');
                }
            } catch (error) {
                console.error('Error resetting mood:', error);
                alert('Error resetting mood');
            }
        }

        // Confirm and clear news via admin endpoint
        function clearNewsConfirm() {
            if (!confirm('Clear processed news entries from the database and reset mood? This will delete news context stored in Qdrant.')) return;
            const limitInput = prompt('How many entries should be cleared? (default 100)');
            const limit = limitInput ? parseInt(limitInput, 10) || 100 : 100;
            clearNews(limit);
        }

        async function clearNews(limit = 100) {
            try {
                const response = await fetch(`${API_BASE}/api/admin/clear-news`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ limit })
                });
                const result = await response.json();
                if (response.ok) {
                    alert(`Cleared ${result.deleted} news entries and reset mood`);
                    loadDashboard();
                } else {
                    alert('Failed to clear news entries');
                }
            } catch (error) {
                console.error('Error clearing news:', error);
                alert('Error clearing news entries');
            }
        }

        // Admin dev-mock functions
        async function getDevMockStatus() {
            try {
                const res = await fetch(`${API_BASE}/api/admin/dev-mock`);
                if (!res.ok) return updateDevMockUI(null);
                const body = await res.json();
                updateDevMockUI(!!body.devMock);
            } catch (e) {
                console.error('Error fetching dev-mock status:', e);
                updateDevMockUI(null);
            }
        }

        function updateDevMockUI(enabled) {
            const statusEl = document.getElementById('devMockStatus');
            const btn = document.getElementById('devMockBtn');
            if (!statusEl || !btn) return;
            if (enabled === null) {
                statusEl.textContent = 'unknown';
                btn.style.opacity = '0.6';
            } else if (enabled) {
                statusEl.textContent = 'ON';
                btn.style.background = '#20c997';
                btn.style.color = '#fff';
                btn.style.opacity = '1';
            } else {
                statusEl.textContent = 'OFF';
                btn.style.background = '#6f42c1';
                btn.style.color = '#fff';
                btn.style.opacity = '1';
            }
        }

        async function toggleDevMockUI() {
            try {
                const currentResponse = await fetch(`${API_BASE}/api/admin/dev-mock`);
                const data = currentResponse.ok ? await currentResponse.json() : { devMock: false };
                const newState = !data.devMock;
                const res = await fetch(`${API_BASE}/api/admin/dev-mock`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: newState })
                });
                if (res.ok) {
                    updateDevMockUI(newState);
                    alert('Dev mock ' + (newState ? 'enabled' : 'disabled'));
                } else {
                    const err = await res.json().catch(() => ({}));
                    alert('Failed to toggle dev-mock: ' + (err.error || res.status));
                }
            } catch (e) {
                console.error('Error toggling dev-mock:', e);
                alert('Error toggling dev-mock');
            }
        }
    </script>
</body>
</html>
